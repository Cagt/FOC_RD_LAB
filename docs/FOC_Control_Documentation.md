# FOC BLDC/PMSM 仿真实验室文档

## 概述

本项目是一个基于FOC（磁场定向控制）的BLDC/PMSM电机仿真平台，用于研究和验证各种控制算法。该平台提供了完整的电机模型、FOC控制算法、弱磁控制、参数自学习和抗干扰控制等功能，并配有直观的可视化界面。

## 系统架构

### 核心模块

1. **电机模型 (motor_model.py)**
   - 实现PMSM电机的数学模型
   - 支持d-q坐标系下的电气和机械动态方程
   - 提供三相电流转换和DC母线电流计算

2. **FOC控制器 (foc_control.py)**
   - 实现完整的FOC控制算法
   - 包括Clarke和Park变换
   - 空间矢量脉宽调制(SVPWM)
   - PI电流和速度控制器

3. **弱磁控制 (flux_weakening.py)**
   - 实现多种弱磁控制策略
   - 支持电压法、速度法和查表法
   - 扩展电机运行速度范围

4. **参数自学习 (self_learning.py)**
   - 在线参数辨识算法
   - 基于递归最小二乘法(RLS)
   - 辨识电阻、电感、磁链和机械参数

5. **抗干扰控制 (disturbance_rejection.py)**
   - 扰动观测器
   - 自适应控制
   - 滑模控制和H∞控制

6. **可视化系统 (visualization.py)**
   - 实时数据可视化
   - 多种图表显示电机状态
   - 参数辨识过程可视化

7. **主仿真程序 (simulation.py)**
   - 集成所有控制模块
   - 提供GUI界面
   - 支持实时仿真和参数调整

## 理论基础

### PMSM电机模型

在d-q旋转坐标系下，PMSM电机的数学模型可以表示为：

**电压方程：**
```
vd = Rs*id - ωr*Lq*iq + Ld*did/dt
vq = Rs*iq + ωr*Ld*id + ωr*ψf + Lq*diq/dt
```

**转矩方程：**
```
Te = 1.5 * P * (ψf*iq + (Ld - Lq)*id*iq)
```

**机械方程：**
```
Te = TL + B*ωm + J*dωm/dt
```

其中：
- vd, vq: d-q轴电压
- id, iq: d-q轴电流
- Rs: 定子电阻
- Ld, Lq: d-q轴电感
- ψf: 永磁体磁链
- ωr: 电气角速度
- P: 极对数
- Te: 电磁转矩
- TL: 负载转矩
- B: 摩擦系数
- J: 转动惯量
- ωm: 机械角速度

### FOC控制原理

FOC控制的基本原理是通过坐标变换将三相交流电机模型等效为直流电机模型，从而实现转矩和磁通的解耦控制。

**控制流程：**
1. 测量三相电流 (ia, ib, ic)
2. Clarke变换：三相 → α-β坐标系
3. Park变换：α-β → d-q坐标系
4. PI控制器：电流环和速度环
5. 反Park变换：d-q → α-β坐标系
6. SVPWM：生成逆变器开关信号

### 弱磁控制

当电机转速超过基速时，反电动势会超过逆变器所能提供的最大电压。弱磁控制通过注入负的d轴电流来减小有效磁链，从而扩展电机的高速运行范围。

**弱磁条件：**
```
v = sqrt(vd² + vq²) ≤ Vmax
```

### 参数辨识

参数辨识是通过分析电机的输入输出数据来估计电机参数的过程。本项目采用递归最小二乘法(RLS)进行在线参数辨识：

**RLS更新公式：**
```
θ(k) = θ(k-1) + K(k) * [y(k) - φ(k)ᵀ * θ(k-1)]
K(k) = P(k-1) * φ(k) / [λ + φ(k)ᵀ * P(k-1) * φ(k)]
P(k) = [P(k-1) - K(k) * φ(k)ᵀ * P(k-1)] / λ
```

其中：
- θ: 参数向量
- φ: 回归向量
- y: 测量输出
- K: 增益向量
- P: 协方差矩阵
- λ: 遗忘因子

## 使用指南

### 安装依赖

```bash
pip install -r requirements.txt
```

### 运行仿真

```bash
python src/simulation.py
```

### 运行测试

```bash
python tests/test_scenarios.py
```

### GUI操作指南

1. **速度控制**
   - 使用速度滑块设置参考速度（-3000到3000 RPM）
   - 观察速度响应和电流波形

2. **负载转矩**
   - 使用负载滑块设置负载转矩（0到10 N.m）
   - 测试抗干扰控制效果

3. **控制选项**
   - 勾选"弱磁控制"启用弱磁功能
   - 勾选"参数自学习"启用在线参数辨识
   - 勾选"抗干扰控制"启用扰动观测器

4. **弱磁控制方法**
   - 电压法：基于电压误差的弱磁控制
   - 速度法：基于速度的弱磁控制
   - 查表法：基于预计算查表的弱磁控制

5. **仿真控制**
   - 开始：启动仿真
   - 暂停：暂停仿真
   - 重置：重置所有状态
   - 仿真速度：调整仿真速度（0.1x到5x）

## 研究应用

### 1. 弱磁控制算法研究

该平台可用于研究和比较不同的弱磁控制策略：

- **电压法弱磁控制**：基于电压误差的PI控制，简单易实现但响应较慢
- **速度法弱磁控制**：基于速度的前馈控制，响应快但需要精确的电机参数
- **查表法弱磁控制**：基于离线计算的优化表，性能最优但需要大量存储空间

**研究建议：**
1. 比较不同弱磁方法的动态响应特性
2. 研究参数变化对弱磁控制性能的影响
3. 开发新型自适应弱磁控制算法

### 2. 电机参数自学习

该平台支持在线参数辨识，可用于：

- **参数变化监测**：监测电机参数随温度、老化等因素的变化
- **自适应控制**：根据辨识结果自动调整控制器参数
- **故障诊断**：通过参数异常检测电机故障

**研究建议：**
1. 研究不同工况下的参数辨识精度
2. 开发更鲁棒的参数辨识算法
3. 结合机器学习方法提高辨识精度

### 3. 抗干扰控制算法

该平台提供了多种抗干扰控制方法：

- **扰动观测器**：估计并补偿外部扰动
- **自适应控制**：根据性能自动调整控制器增益
- **滑模控制**：对参数变化和外部扰动具有强鲁棒性
- **H∞控制**：优化系统鲁棒性和性能

**研究建议：**
1. 比较不同抗干扰方法的性能
2. 研究复合控制策略
3. 开发基于人工智能的抗干扰控制算法

## 实验案例

### 案例1：弱磁控制性能测试

**目标：** 测试电机在高速区域的弱磁控制性能

**步骤：**
1. 设置速度参考为2000 RPM（高于基速）
2. 启用弱磁控制
3. 分别测试三种弱磁方法
4. 观察id、iq波形和电压利用率

**预期结果：**
- 电机能够稳定运行在高于基速的区域
- d轴电流为负值（弱磁电流）
- 电压保持在限制范围内

### 案例2：参数自学习实验

**目标：** 验证参数辨识算法的准确性

**步骤：**
1. 修改电机参数（模拟参数变化）
2. 启用参数自学习功能
3. 运行电机在不同工况下
4. 观察参数辨识结果

**预期结果：**
- 辨识参数逐渐接近真实值
- 辨识过程收敛
- 控制性能随参数辨识精度提高而改善

### 案例3：抗干扰控制实验

**目标：** 测试抗干扰控制对负载扰动的抑制能力

**步骤：**
1. 设置恒定速度参考
2. 在0.5-1.5秒期间施加5 N.m负载扰动
3. 分别测试有无抗干扰控制的情况
4. 比较速度波动和恢复时间

**预期结果：**
- 有抗干扰控制时速度波动更小
- 恢复时间更短
- 扰动观测器能准确估计扰动

## 扩展开发

### 1. 添加新型控制算法

可以在现有框架基础上添加新的控制算法：

```python
class NewControlAlgorithm:
    def __init__(self, config_file):
        # 初始化参数
        pass
    
    def update(self, measurements):
        # 实现控制算法
        pass
```

### 2. 扩展电机模型

可以添加更多类型的电机模型：

```python
class BLDCModel(PMSMModel):
    def __init__(self, config_file):
        super().__init__(config_file)
        # BLDC特有参数
        pass
    
    def update(self, inputs):
        # BLDC特有模型
        pass
```

### 3. 增强可视化功能

可以添加更多可视化功能：

```python
class EnhancedVisualization(MotorControlVisualization):
    def __init__(self, master):
        super().__init__(master)
        # 添加新的图表
        pass
    
    def add_new_plot(self):
        # 实现新的图表
        pass
```

## 故障排除

### 常见问题

1. **仿真运行缓慢**
   - 降低仿真速度
   - 减小数据缓冲区大小
   - 关闭不必要的可视化

2. **参数辨识不收敛**
   - 检查激励信号是否充分
   - 调整遗忘因子
   - 增加辨识时间

3. **弱磁控制效果不佳**
   - 检查电机参数是否准确
   - 调整弱磁控制增益
   - 尝试不同的弱磁方法

4. **抗干扰控制性能差**
   - 调整观测器带宽
   - 检查负载转矩设置
   - 尝试不同的抗干扰方法

## 参考文献

1. "Control of Electric Machine Drives" by Seung-Ki Sul
2. "Permanent Magnet Synchronous and Brushless DC Motor Drives" by R. Krishnan
3. "Modeling and High-Performance Control of Electric Machines" by John Chiasson
4. "Applied Control of Electrical Drives" by Andrzej M. Trzynadlowski

## 许可证

本项目采用MIT许可证，详见LICENSE文件。

## 贡献指南

欢迎提交问题报告和功能请求。如果您想贡献代码，请：

1. Fork本项目
2. 创建功能分支
3. 提交更改
4. 创建Pull Request

## 联系方式

如有问题或建议，请通过以下方式联系：

- 邮箱：your.email@example.com
- 项目主页：https://github.com/yourusername/FOC_RD_LAB